# Copyright 2021-2022 The OpenSSL Project Authors. All Rights Reserved.
#
# Licensed under the Apache License 2.0 (the "License").  You may not use
# this file except in compliance with the License.  You can obtain a copy
# in the file LICENSE in the source distribution or at
# https://www.openssl.org/source/license.html

name: Compiler Zoo CI

on: [push]

jobs:
  compiler:
    strategy:
      fail-fast: false
      matrix:
        # We enable LTO for the latest compilers only (because it's a more exptensive build)
        # as an additional job to get more coverage.
        zoo: [
          {
            cc: gcc-7,
            distro: ubuntu-20.04
          }, {
            cc: gcc-8,
            distro: ubuntu-20.04
          }, {
            cc: gcc-9,
            distro: ubuntu-20.04
          }, {
            cc: gcc-10,
            distro: ubuntu-20.04
          }, {
            cc: gcc-11,
            distro: ubuntu-22.04
          }, {
            cc: gcc-12,
            distro: ubuntu-22.04,
          }, {
            cc: gcc-12,
            distro: ubuntu-22.04,
            lto: -flto=4
          }, {
            cc: clang-6.0,
            distro: ubuntu-20.04
          }, {
            cc: clang-7,
            distro: ubuntu-20.04
          }, {
            cc: clang-8,
            distro: ubuntu-20.04
          }, {
            cc: clang-9,
            distro: ubuntu-20.04
          }, {
            cc: clang-10,
            distro: ubuntu-20.04
          }, {
            cc: clang-11,
            distro: ubuntu-20.04
          }, {
            cc: clang-12,
            distro: ubuntu-20.04
          }, {
            cc: clang-13,
            distro: ubuntu-22.04
          }, {
            cc: clang-14,
            distro: ubuntu-22.04
          }, {
            cc: clang-14,
            distro: ubuntu-22.04,
            # Clang 14.0.0 seems to take a *long* time to build some of the fuzz infra
            # with -O3 + LTO
            lto: -O2 -flto -flto-jobs=4
          }, {
            cc: clang-14,
            distro: ubuntu-22.04,
            # Clang 14.0.0 seems to take a *long* time to build some of the fuzz infra
            # with -O3 + LTO
            lto: -O2 -flto=thin -flto-jobs=4
          }
        ]
    # We set per-compiler now to allow testing with both older and newer sets
    # Often, the full range of oldest->newest compilers we want aren't available
    # in a single version of Ubuntu.
    runs-on: ${{ matrix.zoo.distro }}
    steps:
    - name: install packages
      run: |
        sudo apt-get update
        sudo apt-get -yq --force-yes install ${{ matrix.zoo.cc }}
    - uses: actions/checkout@v2

    - name: config
      run: |
        CC=${{ matrix.zoo.cc }} ./config --banner=Configured no-shared \
            ${{ matrix.zoo.lto}} -Wall -Werror enable-fips --strict-warnings

    - name: config dump
      run: ./configdata.pm --dump
    - name: make
      run: make -j4
    - name: make test
      run: make test HARNESS_JOBS=${HARNESS_JOBS:-4}
